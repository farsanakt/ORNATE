<%- include('../layouts/header.ejs') %>

	<div class="page-wrapper">

		<%- include('../layouts/navbar-2.ejs') %>

			<main class="main">
				<div class="page-header text-center"
					style="background-image: url('assets/images/urban/allProducts.jpeg')">
					<div class="container">
						<h1 class="page-title text-white ">Checkout<span>Shop</span></h1>
					</div><!-- End .container -->
				</div><!-- End .page-header -->
				<nav aria-label="breadcrumb" class="breadcrumb-nav">
					<div class="container">
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="index.html">Home</a></li>
							<li class="breadcrumb-item"><a href="#">Cart</a></li>
							<li class="breadcrumb-item active" aria-current="page">Checkout</li>
						</ol>
					</div><!-- End .container -->
				</nav><!-- End .breadcrumb-nav -->

				<!-- Button trigger modal -->

				<!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#changeAddressModal">
				Launch demo modal
			</button> -->

				<!--Modal Choose Address-->


				<div class="modal fade" id="changeAddressModal" tabindex="-1" aria-labelledby="changeAddressModal" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h1 class="modal-title fs-5" id="exampleModalLabel">Choose Address</h1>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<div class="row">
									<% for (let i=0; i < addres?.addresss?.length; i++) { %>
										<% if (addres.addresss[i].status == false) { %>
											<div data-bs-dismiss="modal" class="col-lg-5" style="margin: auto;">
												<div class="card card-dashboard mt-2 style" style="width: 100;box-shadow:1px 1px 4px 0px#888888;" onclick="addresChoose('<%= addres.addresss[i]._id %>')">
													<div class="card-body" style="cursor: pointer;">
														<h3 class="card-title">Address</h3>
														<p><span style="font-size: 1vw;"><%= addres.addresss[i].name %></span></p>
														<p>
															<span><%= addres.addresss[i].address %></span>,
															<br><span><%= addres.addresss[i].locality %>,</span>
															<span><%= addres.addresss[i].city %>,</span>
															<span><%= addres.addresss[i].state %>,</span>
															<span><%= addres.addresss[i].pincode %></span>
															<br>
															<span>Phone: <%= addres.addresss[i].phone %></span>
														</p>
														<a href="#" style="cursor: pointer; color: rgb(207, 149, 77);" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="editAddress('<%= addres.addresss[i]._id %>')">Edit<i class="icon-edit"></i></a>
													</div><!-- End .card-body -->
												</div><!-- End .card-dashboard -->
											</div><!-- End .col-lg-5 -->
										<% } %>
									<% } %>
								</div><!-- End .row -->
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				

				<div class="page-content">
					<div class="checkout">
						<div class="container">
							<div class="row">
								<aside class="col-lg-9">
									

									<div class="cart-bottom">
										<div class="cart-discount">
											<form action="/addcoupen" method="post">
												<div class="input-group">
													<input type="text" name="couponId" class="form-control" required
														placeholder="coupon code">
													<div class="input-group-append">
														<button class="btn btn-outline-primary-2" type="submit"><i
																class="icon-long-arrow-right"></i></button>
													</div><!-- .End .input-group-append -->
												</div><!-- End .input-group -->
											</form>
											<% console.log(msg); %>
												<p class="<%=msg=='coupen applied'?'text-success':'text-danger'%>">
													<%=msg %>
												</p>
										</div><!-- End .cart-discount -->

								
									</div><!-- End .cart-bottom -->
									<!-- Button to trigger modal -->


									<!--  add addredd Modal -->
									<div class="modal fade" id="addressModal" tabindex="-1"
										aria-labelledby="addressModalLabel" aria-hidden="true">
										<!-- Add Addres Modal -->

										<div class="modal-dialog">
											<div class="modal-content">

												<div class="modal-header">
													<h6 class="modal-title " id="exampleModalLabel">Add Address</h6>
													<button type="button" class="btn-close" data-bs-dismiss="modal"
														aria-label="Close"></button>
												</div>

												<div class="modal-body">

													<form method="post" style="padding-left: 15px;padding-right: 15px;"
														id="addform">

														<p id="msg" hidden>
															<%= //msgg %>
														</p>

														<div class="row">

															<div class="col-lg-6">
																<label for="name" class="col-form-label text-black">Name
																	*</label>
																<input type="text" class="form-control" name="name"
																	id="name" placeholder="Enter your Name" required>
															</div>

															<div class="col-lg-6">
																<label for="phone"
																	class="col-form-label text-black">Mobile Number
																	*</label>
																<input type="text" class="form-control" name="phone"
																	id="phone" placeholder="Enter your Mobile" required>
															</div>

															<div class="col-lg-6">
																<label for="locality"
																	class="col-form-label text-black">Loacality
																	*</label>
																<input type="text" class="form-control" name="locality"
																	id="locality" placeholder="Enter your Locality"
																	required>
															</div>

															<div class="col-lg-6">
																<label for="pincode"
																	class="col-form-label text-black">Pincode *</label>
																<input type="text" class="form-control" name="pincode"
																	id="pincode" placeholder="Enter your pincode"
																	required>
															</div>

														</div>

														<div class="col-lg-11">

															<label for="display-name" class="requird text-dark">Address
																*</label>
															<textarea type="text" id="" cols="76" rows="3"
																placeholder="Enter your Address" name="address"
																required></textarea>

														</div>

														<div class="row mb-1">

															<div class="col-lg-6">
																<label for="city" class="col-form-label text-black">City
																	*</label>
																<input type="text" class="form-control" name="city"
																	id="city" placeholder="Enter your City" required>
															</div>

															<div class="col-lg-6">
																<label for="state"
																	class="col-form-label text-black">State *</label>
																<input type="text" class="form-control" name="state"
																	id="state" placeholder="Enter your State" required>
															</div>

														</div>

													</form>

												</div>

												<div class="modal-footer">
													<button type="button" class="btn btn-secondary"
														data-bs-dismiss="modal">Close</button>
													<button type="submit" class="btn btn-primary"
														data-bs-dismiss="modal"
														onclick="addAddress('<%= userData._id %>')">Add</button>

												</div>

											</div>
										</div>

									</div>

									<% if (!addres || addres.addresss.length==0) { %>

									
										<button type="button" class="btn btn-primary mt-3 justify-content-center"
											data-bs-toggle="modal" data-bs-target="#addressModal">ADD ADDRESS</button>
							</div>
						</div>
					</div>
				</div> -->
				<!--- End Add Address -->

				<form action="" id="addform">

					<div class="row">

						<div class="col-lg-9">

							<!-- <h2 class="checkout-title">Billing Details</h2>End .checkout-title -->



							<div class="text-center text-info" style="margin-top: 20rem;">
								<p>Click The Add Address Button to Add Address</p>
							</div><!--Message-->

							<div class="row">

								<div class="col-sm-6">

									<!-- <label>Name *</label>
														<input type="text" class="form-control" name="name" required> -->

								</div><!---End .col-sm-6-->

								<div class="col-sm-6">

									<!-- <label>Mobile Number *</label>
														<input type="text" class="form-control" name="phone" required> -->

								</div><!--End .col-sm-6 -->

							</div><!---End .row -->

							


							

					

						</div><!--End .col-lg-9-->

						<% } else { %>

							<!-- <form action="#"> -->

							<div class="row">

								<div class="col-lg-9">

									<div class="row">

										<% for (let i=0; i < addres.addresss?.length; i++) { %>

											<% if (addres.addresss[i].status==true) { %>


												<div class="col-lg-5">

													<div class="card card-dashboard mt-1">

														<div class="card-body" style="padding: 20px; cursor: pointer;">

															<!-- <input type="checkbox" class="card-checkbox mb-2 "> -->

															<!-- <button type="button" class="close" aria-label="Close"  style="font-size: 23px;padding-bottom: 20px;" onclick="deleteAdd('' , '')">
																<span aria-hidden="true">&times;</span>
															</button> -->

															<span
																style="cursor: pointer; display: flex; justify-content: end;"
																data-bs-toggle="modal"
																data-bs-target="#changeAddressModal">Change</span>

															<h3 class="card-title">Address</h3><!-- End .card-title -->

															<p><span>
																	<%= addres.addresss[i].name %>
																</span></p>
															<p><span>
																	<%= addres.addresss[i].addresss %>
																</span>,
																<br><span>
																	<%= addres.addresss[i].locality %>,
																</span>
																<span>
																	<%= addres.addresss[i].city %>,
																</span>
																<span>
																	<%= addres.addresss[i].state %>,
																</span>
																<span>
																	<%= addres.addresss[i].pincode %>
																</span>
																<br>
																<span>Phone: <%= addres.addresss[i].phone %> </span>
															</p>

														

														</div><!-- End .card-body -->

													</div><!-- End .card-dashboard -->

												</div><!-- End .col-lg-6 -->

												<% } %>

													<!--Edit Address Modal-->

													<div class="modal fade" id="exampleModal" tabindex="-1"
														aria-labelledby="exampleModalLabel" aria-hidden="true">

														<div class="modal-dialog">

															<div class="modal-content">

																<div class="modal-header">
																	<h1 class="modal-title fs-5" id="exampleModalLabel">
																		Edit Address</h1>
																	<button type="button" class="btn-close"
																		data-bs-dismiss="modal"
																		aria-label="Close"></button>
																</div>

																<div class="modal-body" style="padding: 13px;">

																	<form action="verifyEditAddCheckout" method="post"
																		style="padding-left: 15px;padding-right: 15px;"
																		id="">

																		<p class="" hidden id="msg">
																			<%= // msgg %>
																		</p>

																		<div class="row">

																			<div class="col-lg-6">
																				<label for="name"
																					class="col-form-label text-black">Name
																					*</label>
																				<input type="text" class="form-control"
																					name="name" id="name"
																					placeholder="Enter your Name"
																					required>
																			</div>

																			<div class="col-lg-6">
																				<label for="phone"
																					class="col-form-label text-black">Mobile
																					Number *</label>
																				<input type="text" class="form-control"
																					name="phone" id="phone"
																					placeholder="Enter your Mobile"
																					required>
																			</div>

																			<div class="col-lg-6">
																				<label for="locality"
																					class="col-form-label text-black">Loacality
																					*</label>
																				<input type="text" class="form-control"
																					name="locality" id="locality"
																					placeholder="Enter your Locality"
																					required>
																			</div>

																			<div class="col-lg-6">
																				<label for="pincode"
																					class="col-form-label text-black">Pincode
																					*</label>
																				<input type="text" class="form-control"
																					name="pincode" id="pincode"
																					placeholder="Enter your pincode"
																					required>
																			</div>

																		</div>

																		<div class="col-lg-12">

																			<label for="display-name"
																				class=" requird text-dark">Address
																				*</label>
																			<textarea type="text" style="color: gray;"
																				id="addresssss" class="form-control "
																				rows="3"
																				placeholder="Enter your Address"
																				name="address" required></textarea>

																		</div>

																		<div class="row mb-1">

																			<div class="col-lg-6">
																				<label for="city"
																					class="col-form-label text-black">City
																					*</label>
																				<input type="text" class="form-control"
																					name="city" id="city"
																					placeholder="Enter your City"
																					required>
																			</div>

																			<div class="col-lg-6">
																				<label for="state"
																					class="col-form-label text-black">State
																					*</label>
																				<input type="text" class="form-control"
																					name="state" id="state"
																					placeholder="Enter your State"
																					required>
																			</div>

																		</div>

																		<input type="hidden" name="id" id="id">

																		<div class="modal-footer">
																			<button type="button"
																				class="btn btn-secondary"
																				data-bs-dismiss="modal">Close</button>
																			<button type="submit"
																				class="btn btn-primary">Save
																				changes</button>
																		</div>

																	</form>

																</div>

															</div>

														</div>

													</div>

													<% } %>

									</div><!-- End .row -->

									

								


									



								</div><!--End .col-lg-9-->

								<% } %>



							</div>
							</aside>
							<aside class="col-lg-3">
								<div class="summary">
									<h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

									<table class="table table-summary">
										<thead>
											<tr>
												<th>Product</th>
												<th>Total</th>
											</tr>
										</thead>

										<tbody>

											<% locals?.cartData?.products?.forEach((product, index)=> { %>

												<tr>

													<td><a href="#">
															<%=product.productId.name %>
														</a></td>
													<td>₹<%=product.price%>.00</td>
												</tr>

												<% }) %>


													<tr class="summary-subtotal">
														<td>Subtotal:</td>
														<td>₹<%= cartData?.totalCartPrice %>.00</td>
													</tr><!-- End .summary-subtotal -->

													<tr class="summary-subtotal">
														<td>Coupen Offer:</td>
														<td>
															<%= offer?offer:0; %>%
														</td>
													</tr><!-- End .summary-subtotal -->
													<tr>
														<td>Shipping:</td>
														<td><%=ship  %> ₹	<%=shipped  %></td>
													</tr>
													<tr class="d-none">
														
														<% const offr=offer?offer:0; %>
														<td><%= parseInt((cartData?.totalCartPrice)-(cartData?.totalCartPrice*offr/100)) %>  </td></tr>

													<tr class="summary-total">
														<td>Total:</td>
														
														<% if(offer){ %><% const off=offer?offer:0; %>
															<td>₹<%= parseInt(cartData?.totalCartPrice-(cartData?.totalCartPrice*(off/100)))+Number(shipped) %>
																	.00</td><%  } else{ %> 
																		<td>₹<%= cartData?.totalCartPrice+Number(shipped) %>
																	<% } %>
													</tr><!-- End .summary-total -->

										</tbody>


									</table><!-- End .table table-summary -->



									<form id="myForm" action="/getOrder" method="post">

										<% if(err){ %><p style="color: red;"  id="msg">
											<%=  err %>
										</p>
										<% } %>

										<div class="card">
											<div class="card-header" id="payment-methods-heading">
												<h2 class="card-title">Payment Method</h2>
											</div>
											<div class="card-body">
												<label>
													<input checked type="radio" name="paymentmethod" id="cod" value="cod">
													Cash on Delivery
												</label><br>
												<label>
													<input type="radio" name="paymentmethod" id="wallet" value="wallet">
													Wallet
												</label><br>
												<label>
													<input type="radio" name="paymentmethod" id="razorpay"
														value="online payment">
													Razorpay
												</label>
											</div>
										</div>

										<div>

											<% if (!cartData?.products || cartData?.products?.length==0) { %>

												<a href="/product"
													class="btn btn-outline-primary-2 btn-order btn-block">ADD PRODUCT TO
													CART</a>

												<% } else { %>
<%const shippingPrice=Number(shipped)|| 0 %>
													<button onclick="submit1('<%= cartData?.totalCartPrice+shippingPrice %>')"
														type="button"
														class="btn btn-outline-primary-2 btn-order btn-block">
														<span class="btn-text">Place Order</span>
														<span class="btn-hover-text">Proceed to Checkout</span>
													</button>

													<% } %>

										</div>

									</form>

								</div><!-- End .summary -->
							</aside>
					</div>
	</div>
	</div>
	</div>



	</div>

	<div class="page-content">
		<div class="checkout">
			<div class="container">
				<!-- End .row -->

				<!-- </form> -->

			</div><!-- End .container -->
		</div><!-- End .checkout -->
	</div><!-- End .page-content -->
	</main><!-- End .main -->

	<!-- Connect Footer -->
	<%- include('../layouts/footbar-2') %>
		<!-- Connect Footer -->

		</div><!-- End .page-wrapper -->

		<button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

		<!--Connect Mobaile View-->
		<%- include('../layouts/mobileView.ejs') %>
			<!--Connect Mobaile View-->

			<!-- Plugins JS File -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/bootstrap.bundle.min.js"></script>
			<script src="assets/js/jquery.hoverIntent.min.js"></script>
			<script src="assets/js/jquery.waypoints.min.js"></script>
			<script src="assets/js/superfish.min.js"></script>
			<script src="assets/js/owl.carousel.min.js"></script>
			<!-- Main JS File -->
			<script src="assets/js/main.js"></script>

			<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

			<script>

				function submit1(amount) {
					console.log('lllll');
					const form = document.getElementById('myForm');
					console.log(form);

					// var formData = new FormData(document.getElementById('myForm'));

					const Radio = document.querySelector('input[name="paymentmethod"]:checked').value;

					console.log(Radio);

					if (Radio == 'online payment') {
						razorpay(amount);
					}
					else {
						form.submit();
					}

				}
				//  Add razor Section :-

				function razorpay(amount) {
					console.log('reached razor' + amount);
					const form = document.getElementById('myForm');
					fetch('/razor', {
						method: 'POST',
						headers: { 'Content-type': 'application/json' },
						body: JSON.stringify({ amount })
					}).then(res => res.json()).then(data => {
						if (data.succes) {

							let options = {
								"key": `${data.key_id}`,
								"amount": `${data.amount}`,
								"currency": "INR",
								"name": "ORNATE",
								"order_id": `${data.order_id}`,
								"handler": function (response) {
									form.submit();

								},
								"profile": {
									"name": `${data.name}`,
									"email": `${data.email}`
								}
							}

							let razorpayObject = new Razorpay(options);
							razorpayObject.on('payment.failed', (response) => {
								form.action = '/failedRazorpay'
				                form.submit()
							});
							razorpayObject.open();
						}
					})
				}




				//  Add Address Section :-
				function addAddress(id) {

					const form = document.getElementById('addform');

					const formData = new FormData(form)
					const addressData = {}

					formData.forEach((value, key) => {

						addressData[key] = value;

					});

					fetch(`/chekoutAddAddress?id=${id}`, {

						method: 'POST',

						headers: {

							'Content-Type': 'application/json'

						},

						body: JSON.stringify({ addressData })

					})

						.then(res => res.json()).then(data => {

							if (data.suc) {

								Swal.fire({

									title: 'Address Added',
									text: 'Address Added Successfully',
									icon: 'success',
									confirmButtonText: 'OK'

								}).then((result) => {

									window.location.href = '/checkout'

								})

							} else {

								Swal.fire({

									title: 'Failed',
									text: 'Address Adding Failed',
									icon: 'error',
									confirmButtonText: 'OK'

								}).then((result) => {

									window.location.href = '/checkout'

								})

							}

						})

				}

				//	Delete Address :-

				function deleteAdd(id, addId) {

					fetch(`/deleteCheckAdd?id=${id}&userid=${addId}`, { method: 'POST' })


						.then(data => {

							if (data.ok) {

								Swal.fire({

									title: "Are you sure?",
									text: "You won't be able to delete this address!",
									icon: "warning",
									showCancelButton: true,
									confirmButtonColor: "#3085d6",
									cancelButtonColor: "#d33",
									confirmButtonText: "Yes, delete it!"

								}).then((result) => {

									if (result.isConfirmed) {

										Swal.fire({

											title: "Deleted!",
											text: "Your Address has been deleted.",
											icon: "success"

										}).then((result) => {

											window.location.href = '/checkout'

										})

									}

								})

							}

						})

				};

				//  Edit Address :-

				function editAddress(edit) {

					const namee = document.getElementById('name')
					const phonee = document.getElementById('phone')
					const localityy = document.getElementById('locality')
					const pincodee = document.getElementById('pincode')
					const addressss = document.getElementById('addresssss')
					const cityy = document.getElementById('city')
					const statee = document.getElementById('state')
					const idd = document.getElementById('id');

					fetch('/editAddressCheckout', { method: 'put', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ edit }) })

						.then((res) => res.json())

						.then((data) => {

							const { name, phone, loacality, pincode, address, city, states, _id } = data.editData.addresss[0];


							namee.value = name
							phonee.value = phone
							pincodee.value = pincode
							localityy.value = loacality
							addressss.value = address
							cityy.value = city
							statee.value = states
							idd.value = _id

						})

				};

				</script>

				//	Address Choose :-

				<script>
					function addresChoose(id) {
						console.log('kjjhh');
						fetch(`/chooseAddress?id=${id}`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							}
						}).then(response => {
							if (response.ok) {
								console.log("Address chosen successfully.");
								window.location.href = '/checkout';
							} else {
								console.error("Error choosing address:", response.status);
							}
						}).catch(error => {
							console.error("Error:", error);
						}).finally(() => {
							window.location.reload(); // Reload the page
						});
					}
				</script>
				
				
<script>
				//	Sweet Alert For Edit Address :-

				const msg = document.getElementById('msg');

				if (msg.textContent == 'Address Edited') {

					Swal.fire({

						title: 'Address Edited',
						text: 'Address Edited Successfully',
						icon: 'success',
						confirmButtonText: 'OK'

					})

				};


			</script>

			
			<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

			<style>
				.style:hover {

					background-color: rgb(239, 239, 239);

				}

				.style:active {

					background-color: rgb(211, 211, 211);

				}
			</style>

			<%- include('../layouts/footer') %>